// Prisma Schema for OpenPulse Analytics Platform
// Supports unlimited projects per user with privacy-friendly tracking

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// ============================================
// Better Auth Models
// ============================================

model User {
    id            String   @id @default(cuid())
    email         String   @unique
    emailVerified Boolean  @default(false)
    name          String?
    image         String?
    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt

    // Relations
    sessions       Session[]
    projects       Project[]
    projectMembers ProjectMember[]

    @@map("users")
}

model Session {
    id        String   @id @default(cuid())
    userId    String
    expiresAt DateTime
    token     String   @unique
    ipAddress String?
    userAgent String?
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
    @@index([token])
    @@map("sessions")
}

// ============================================
// Project Models
// ============================================

model Project {
    id          String   @id @default(cuid())
    userId      String
    name        String
    slug        String   @unique
    description String?
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    // Relations
    user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
    members           ProjectMember[]
    events            Event[]
    analyticsSessions AnalyticsSession[]
    pageViews         PageView[]
    devices           Device[]
    referrers         Referrer[]
    geoData           Geo[]

    @@index([userId])
    @@index([slug])
    @@map("projects")
}

model ProjectMember {
    id        String   @id @default(cuid())
    projectId String
    userId    String
    role      String   @default("member") // owner, admin, member, viewer
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
    user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([projectId, userId])
    @@index([projectId])
    @@index([userId])
    @@map("project_members")
}

// ============================================
// Analytics Models
// ============================================

model Event {
    id        String   @id @default(cuid())
    projectId String
    sessionId String
    type      String   @default("pageview") // pageview, custom, etc.
    url       String
    path      String
    referrer  String?
    title     String?
    timestamp DateTime @default(now())

    // Relations
    project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

    @@index([projectId, timestamp])
    @@index([sessionId])
    @@index([projectId, type, timestamp])
    @@map("events")
}

model AnalyticsSession {
    id         String    @id @default(cuid())
    projectId  String
    sessionId  String    @unique
    startedAt  DateTime  @default(now())
    endedAt    DateTime?
    duration   Int? // Duration in seconds
    pageViews  Int       @default(1)
    isBounce   Boolean   @default(true)
    entryPage  String
    exitPage   String?
    deviceId   String?
    referrerId String?
    geoId      String?

    // Relations
    project  Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
    device   Device?   @relation(fields: [deviceId], references: [id])
    referrer Referrer? @relation(fields: [referrerId], references: [id])
    geo      Geo?      @relation(fields: [geoId], references: [id])

    @@index([projectId, startedAt])
    @@index([sessionId])
    @@map("analytics_sessions")
}

model PageView {
    id          String   @id @default(cuid())
    projectId   String
    path        String
    title       String?
    views       Int      @default(1)
    uniqueViews Int      @default(1)
    date        DateTime @default(now())

    // Relations
    project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

    @@unique([projectId, path, date])
    @@index([projectId, date])
    @@map("page_views")
}

model Device {
    id             String   @id @default(cuid())
    projectId      String
    browser        String
    browserVersion String?
    os             String
    osVersion      String?
    deviceType     String // desktop, mobile, tablet
    screenWidth    Int?
    screenHeight   Int?
    createdAt      DateTime @default(now())
    updatedAt      DateTime @updatedAt

    // Relations
    project  Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
    sessions AnalyticsSession[]

    @@unique([projectId, browser, os, deviceType, screenWidth, screenHeight])
    @@index([projectId])
    @@map("devices")
}

model Referrer {
    id        String   @id @default(cuid())
    projectId String
    url       String
    domain    String
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    project  Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
    sessions AnalyticsSession[]

    @@unique([projectId, domain])
    @@index([projectId])
    @@map("referrers")
}

model Geo {
    id        String   @id @default(cuid())
    projectId String
    country   String
    city      String?
    region    String?
    timezone  String?
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    project  Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
    sessions AnalyticsSession[]

    @@unique([projectId, country, city])
    @@index([projectId])
    @@map("geo")
}

// ============================================
// IP Anonymization Helper
// ============================================
// Note: IP addresses should be anonymized before storage
// Remove last octet for IPv4: 192.168.1.123 -> 192.168.1.0
// Remove last 80 bits for IPv6: 2001:0db8::1234 -> 2001:0db8::
// This should be done in application code, not in Prisma
